<?php
/**
 * @var \Zaca\Events\Block\EventList $block
 */
?>
<?php if (!$block->isModuleEnabled()): ?>
    <div class="events-disabled-message">
        <div class="message message-notice notice">
            <div><?= $block->escapeHtml(__('Events are currently not available.')) ?>        </div>
    </div>
</div>
<?php else: ?>
<div class="zacatrus-events-list">
    <div class="events-filters">
        <form method="get" action="<?= $block->escapeUrl($block->getUrl($block->getRoutePath())) ?>" id="events-filter-form">
            <div class="filter-group location-filter-group">
                <label><?= $block->escapeHtml(__('Filter by Location')) ?></label>
                <div class="location-filter-buttons">
                    <a href="<?= $block->escapeUrl($block->getUrl($block->getRoutePath(), ['_query' => array_filter(['meet_type' => $block->getRequest()->getParam('meet_type'), 'theme_id' => $block->getRequest()->getParam('theme_id')])])) ?>" 
                       class="location-filter-link <?= !$block->getRequest()->getParam('location_id') ? 'active' : '' ?>">
                        <?= $block->escapeHtml(__('Show all')) ?>
                    </a>
                    <?php $locations = $block->getLocations(); ?>
                    <?php if (is_array($locations) || $locations instanceof \Traversable): ?>
                        <?php foreach ($locations as $location): ?>
                        <?php 
                        $address = $location->getAddress();
                        $city = $location->getCity();
                        $postalCode = $location->getPostalCode();
                        $addressParts = [];
                        if ($address) {
                            $addressParts[] = $address;
                        }
                        if ($postalCode) {
                            $addressParts[] = $postalCode;
                        }
                        if ($city) {
                            $addressParts[] = $city;
                        }
                        $fullAddress = implode(', ', $addressParts);
                        $isActive = $block->getRequest()->getParam('location_id') == $location->getLocationId();
                        ?>
                        <button type="button" 
                                class="location-filter-btn <?= $isActive ? 'active' : '' ?>" 
                                data-location-id="<?= $block->escapeHtml($location->getLocationId()) ?>"
                                data-location-name="<?= $block->escapeHtml($location->getName()) ?>"
                                data-location-address="<?= $block->escapeHtml($fullAddress) ?>"
                                title="<?= $block->escapeHtml($fullAddress ?: $location->getName()) ?>">
                            <span class="location-name"><?= $block->escapeHtml($location->getName()) ?></span>
                            <?php if ($fullAddress): ?>
                                <span class="location-address-tooltip"><?= $block->escapeHtml($fullAddress) ?></span>
                            <?php endif; ?>
                        </button>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </div>
                <input type="hidden" name="location_id" id="location-filter-input" value="<?= $block->escapeHtml($block->getRequest()->getParam('location_id') ?: '') ?>">
            </div>

            <div class="filter-group meet-type-filter-group">
                <label><?= $block->escapeHtml(__('Meet Type')) ?></label>
                <div class="meet-type-filter-buttons">
                    <a href="<?= $block->escapeUrl($block->getUrl($block->getRoutePath(), ['_query' => array_filter(['location_id' => $block->getRequest()->getParam('location_id'), 'theme_id' => $block->getRequest()->getParam('theme_id')])])) ?>" 
                       class="meet-type-filter-link <?= !$block->getRequest()->getParam('meet_type') ? 'active' : '' ?>">
                        <?= $block->escapeHtml(__('Show all')) ?>
                    </a>
                    <?php foreach ($block->getEventTypes() as $value => $label): ?>
                        <?php $isActive = $block->getRequest()->getParam('meet_type') == $value; ?>
                        <button type="button" 
                                class="meet-type-filter-btn <?= $isActive ? 'active' : '' ?>" 
                                data-meet-type="<?= $block->escapeHtml($value) ?>"
                                data-meet-type-name="<?= $block->escapeHtml($label) ?>">
                            <?= $block->escapeHtml($label) ?>
                        </button>
                    <?php endforeach; ?>
                </div>
                <input type="hidden" name="meet_type" id="meet-type-filter-input" value="<?= $block->escapeHtml($block->getRequest()->getParam('meet_type') ?: '') ?>">
            </div>

            <div class="filter-group theme-filter-group">
                <label><?= $block->escapeHtml(__('Filter by Theme')) ?></label>
                <div class="theme-filter-buttons">
                    <a href="<?= $block->escapeUrl($block->getUrl($block->getRoutePath(), ['_query' => array_filter(['location_id' => $block->getRequest()->getParam('location_id'), 'meet_type' => $block->getRequest()->getParam('meet_type')])])) ?>" 
                       class="theme-filter-link <?= !$block->getRequest()->getParam('theme_id') ? 'active' : '' ?>">
                        <?= $block->escapeHtml(__('Show all')) ?>
                    </a>
                    <?php $themes = $block->getThemes(); ?>
                    <?php if (is_array($themes) || $themes instanceof \Traversable): ?>
                        <?php foreach ($themes as $theme): ?>
                            <?php $isActive = $block->getRequest()->getParam('theme_id') == $theme->getThemeId(); ?>
                            <button type="button" 
                                    class="theme-filter-btn <?= $isActive ? 'active' : '' ?>" 
                                    data-theme-id="<?= $block->escapeHtml($theme->getThemeId()) ?>"
                                    data-theme-name="<?= $block->escapeHtml($theme->getName()) ?>">
                                <?= $block->escapeHtml($theme->getName()) ?>
                            </button>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </div>
                <input type="hidden" name="theme_id" id="theme-filter-input" value="<?= $block->escapeHtml($block->getRequest()->getParam('theme_id') ?: '') ?>">
            </div>
        </form>
    </div>

    <div class="events-grid">
        <?php $events = $block->getEvents(); ?>
        <?php if (empty($events)): ?>
            <div class="message info empty">
                <span><?= $block->escapeHtml(__('No meets found.')) ?></span>
            </div>
        <?php else: ?>
            <?php foreach ($events as $event): ?>
                <?php $cardBlock = $block->getChildBlock('zacatrus.events.card'); ?>
                <?php if ($cardBlock): ?>
                    <?php $cardBlock->setEvent($event); ?>
                    <?= $cardBlock->toHtml() ?>
                <?php endif; ?>
            <?php endforeach; ?>
        <?php endif; ?>
    </div>
</div>

<script>
require(['domReady!', 'zacatrusEventsRegistration', 'jquery'], function(domReady, registrationHandler, $) {
    // Initialize registration handlers
    try {
        if (registrationHandler && typeof registrationHandler.init === 'function') {
            registrationHandler.init();
        } else {
            console.error('zacatrusEventsRegistration module not properly loaded');
        }
    } catch (e) {
        console.error('Error initializing registration handler:', e);
    }
    
    var tooltipTimeout;
    var clickedButton = null;
    
    // Location filter buttons
    $('.location-filter-btn').on('click', function(e) {
        e.preventDefault();
        var $btn = $(this);
        var locationId = $btn.data('location-id');
        var locationName = $btn.data('location-name');
        var locationAddress = $btn.data('location-address');
        
        // Update active state
        $('.location-filter-btn').removeClass('active');
        $btn.addClass('active');
        
        // Update hidden input
        $('#location-filter-input').val(locationId);
        
        // Show address in tooltip/popup on click (keep it visible)
        if (locationAddress) {
            clickedButton = $btn;
            showLocationAddress($btn, locationName, locationAddress, true);
        } else {
            hideLocationAddress();
        }
        
        // Submit form
        $('#events-filter-form').submit();
    });
    
    // Show address on hover (only if not clicked)
    $('.location-filter-btn').on('mouseenter', function() {
        var $btn = $(this);
        var locationAddress = $btn.data('location-address');
        var locationName = $btn.data('location-name');
        
        // Don't show on hover if this button was clicked
        if (clickedButton && clickedButton.is($btn)) {
            return;
        }
        
        if (locationAddress) {
            clearTimeout(tooltipTimeout);
            showLocationAddress($btn, locationName, locationAddress, false);
        }
    });
    
    // Hide address tooltip on mouse leave (only if not clicked)
    $('.location-filter-btn').on('mouseleave', function() {
        var $btn = $(this);
        
        // Don't hide if this button was clicked
        if (clickedButton && clickedButton.is($btn)) {
            return;
        }
        
        tooltipTimeout = setTimeout(function() {
            hideLocationAddress();
        }, 200);
    });
    
    function showLocationAddress($btn, name, address, isClicked) {
        // Remove existing tooltip
        $('.location-address-popup').remove();
        
        // Create tooltip (without location name, just address)
        var $tooltip = $('<div class="location-address-popup' + (isClicked ? ' clicked' : '') + '">' +
            '<span class="address-text">' + address + '</span>' +
            '</div>');
        
        $('body').append($tooltip);
        
        // Position tooltip
        var btnOffset = $btn.offset();
        var btnWidth = $btn.outerWidth();
        var btnHeight = $btn.outerHeight();
        var tooltipWidth = $tooltip.outerWidth();
        var tooltipHeight = $tooltip.outerHeight();
        var windowWidth = $(window).width();
        var windowHeight = $(window).height();
        var scrollTop = $(window).scrollTop();
        
        // Calculate position
        var top = btnOffset.top + btnHeight + 10;
        var left = btnOffset.left + (btnWidth / 2) - (tooltipWidth / 2);
        
        // Adjust if tooltip goes off screen
        if (left < 10) {
            left = 10;
        } else if (left + tooltipWidth > windowWidth - 10) {
            left = windowWidth - tooltipWidth - 10;
        }
        
        // Adjust if tooltip goes below viewport
        if (top + tooltipHeight > scrollTop + windowHeight - 20) {
            top = btnOffset.top - tooltipHeight - 10;
            $tooltip.addClass('above');
        }
        
        $tooltip.css({
            top: top + 'px',
            left: left + 'px'
        });
        
        $tooltip.fadeIn(200);
    }
    
    function hideLocationAddress() {
        // Don't hide if it's a clicked tooltip
        if ($('.location-address-popup.clicked').length > 0) {
            return;
        }
        
        $('.location-address-popup').fadeOut(200, function() {
            $(this).remove();
        });
    }
    
    // Hide clicked tooltip when clicking elsewhere
    $(document).on('click', function(e) {
        if (!$(e.target).closest('.location-filter-btn, .location-address-popup').length) {
            clickedButton = null;
            hideLocationAddress();
        }
    });
    
    // Meet type filter buttons
    $('.meet-type-filter-btn').on('click', function(e) {
        e.preventDefault();
        var $btn = $(this);
        var meetType = $btn.data('meet-type');
        
        // Update active state
        $('.meet-type-filter-btn').removeClass('active');
        $btn.addClass('active');
        
        // Update hidden input
        $('#meet-type-filter-input').val(meetType);
        
        // Submit form
        $('#events-filter-form').submit();
    });
    
    // Theme filter buttons
    $('.theme-filter-btn').on('click', function(e) {
        e.preventDefault();
        var $btn = $(this);
        var themeId = $btn.data('theme-id');
        
        // Update active state
        $('.theme-filter-btn').removeClass('active');
        $btn.addClass('active');
        
        // Update hidden input
        $('#theme-filter-input').val(themeId);
        
        // Submit form
        $('#events-filter-form').submit();
    });
});
</script>


<?php endif; ?>